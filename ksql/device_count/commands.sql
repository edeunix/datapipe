create stream log_stream ("$table" VARCHAR, type VARCHAR, tenantid VARCHAR, sourcesystem VARCHAR, mg VARCHAR, managementgroupname VARCHAR, timegenerated VARCHAR, computer VARCHAR, rawdata VARCHAR, resulttype VARCHAR, resultdescription VARCHAR, resourceid VARCHAR, operationname VARCHAR, category VARCHAR, level VARCHAR, durationms VARCHAR, properties_s STRUCT<deviceId VARCHAR, protocol VARCHAR, authType VARCHAR, maskedIpAddress VARCHAR, statusCode VARCHAR>, location_s VARCHAR, subscriptionid VARCHAR, resourcegroup VARCHAR, resourceprovider VARCHAR, resource VARCHAR, resourcetype VARCHAR, _resourceid VARCHAR, operationversion VARCHAR, resultsignature VARCHAR, calleripaddress VARCHAR, correlationid VARCHAR, metricname VARCHAR, total VARCHAR, count VARCHAR, maximum VARCHAR, minimum VARCHAR, average VARCHAR, timegrain VARCHAR, unitname VARCHAR, remoteipcountry VARCHAR, remoteiplatitude VARCHAR, remoteiplongitude VARCHAR, maliciousip VARCHAR, indicatorthreattype VARCHAR, description VARCHAR, tlplevel VARCHAR, confidence VARCHAR, severity VARCHAR, firstreporteddate VARCHAR, lastreporteddatetime VARCHAR, isactive VARCHAR, reportreferencelink VARCHAR, additionalinformation VARCHAR) WITH (KAFKA_TOPIC='log-input', VALUE_FORMAT='JSON', PARTITIONS=1, REPLICAS=1);
create stream log_stream_filtered as select timegenerated, properties_s->deviceid, properties_s->maskedIpAddress, properties_s->protocol, properties_s->authtype, operationname from log_stream;
create stream log_stream_keyed as select * FROM log_stream_filtered PARTITION BY properties_s__deviceid;
create stream log_stream_device_connects as select *, 1 as KEYCOL from log_stream_keyed where operationname='deviceConnect';
create table log_table_device_count as select PROPERTIES_S__DEVICEID, OPERATIONNAME, KEYCOL, COUNT(*) AS COUNT FROM log_stream_device_connects window tumbling (size 30 seconds) group by PROPERTIES_S__DEVICEID, OPERATIONNAME, KEYCOL;
create stream log_stream_device_count (PROPERTIES_S__DEVICEID varchar, OPERATIONNAME varchar, KEYCOL int, COUNT BIGINT) with (kafka_topic='LOG_TABLE_DEVICE_COUNT', value_format='JSON', partitions=1, replicas=1);
